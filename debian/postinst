#!/bin/sh

set -e
. /usr/share/debconf/confmodule
         
# variables
MYSQL=`which mysql`
CONFIG=/etc/ras/rasconfig.xml

# set permissions on the installed files
chown root:root /etc/ppp/*
chown root:root /etc/freeradius/sites-available/madesimpleras

# backup some files
cp /etc/network/interfaces /etc/network/interfaces.bak

# link the FreeRADIUS virtual server into the config
if [ ! -e /etc/freeradius/sites-enabled/madesimpleras ]
then
	ln -s /etc/freeradius/sites-available/madesimpleras /etc/freeradius/sites-enabled/madesimpleras
fi
if [ -e /etc/freeradius/sites-enabled/default ]
then
	rm /etc/freeradius/sites-enabled/default
fi

# setup the MySQL database
db_get madesimpleras/mysqlRootPassword
MYSQL_PASSWD=$RET
db_reset madesimpleras/mysqlRootPassword

echo "DROP DATABASE madesimpleras" | $MYSQL -u root -p$MYSQL_PASSWD || true
echo "DROP USER 'madesimpleras'@'localhost'" | $MYSQL -u root -p$MYSQL_PASSWD || true

echo "CREATE DATABASE madesimpleras" | $MYSQL -u root -p$MYSQL_PASSWD
echo "CREATE USER 'madesimpleras'@'localhost' IDENTIFIED BY 'madesimpleras'" | $MYSQL -u root -p$MYSQL_PASSWD
echo "GRANT ALL PRIVILEGES ON madesimpleras.* TO 'madesimpleras'@'localhost' WITH GRANT OPTION" | $MYSQL -u root -p$MYSQL_PASSWD

# insert the FreeRADIUS table schema
$MYSQL -u root -p$MYSQL_PASSWD madesimpleras < /etc/freeradius/sql/mysql/schema.sql
$MYSQL -u root -p$MYSQL_PASSWD madesimpleras < /etc/freeradius/sql/mysql/ippool.sql

# insert some default data for RAS use
$MYSQL -u root -p$MYSQL_PASSWD madesimpleras < /etc/ras/default.sql

# enable the FreeRADIUS MySQL modules (sql/sqlippool)
sed -i.bak "/$INCLUDE sql.conf/ s/# *//" /etc/freeradius/radiusd.conf
sed -i "/$INCLUDE sqlippool.conf/ s/# *//" /etc/freeradius/radiusd.conf

# point to the correct MySQL database
sed -i.bak "s/login = \"radius\"/login = \"madesimpleras\"/" /etc/freeradius/sql.conf
sed -i "s/password = \"radpass\"/password = \"madesimpleras\"/" /etc/freeradius/sql.conf
sed -i "s/radius_db = \"radius\"/radius_db = \"madesimpleras\"/" /etc/freeradius/sql.conf

# update the sqlippool config
sed -i.bak "s/$INCLUDE sql\/postgresql\/ippool.conf/$INCLUDE sql\/mysql\/ippool.conf/" /etc/freeradius/sqlippool.conf

# add configuration for networking
for INTF in `ip link | grep BROADCAST | awk '{print $2}'| awk '{split($0,a,"@"); print a[1]}' | sed s/://g`
do

	# add the interface to the config
	xmlstarlet ed -L -s "/config/interfaces" \
		-t elem -n "interface_tmp" -v "" \
		-i "//interface_tmp" \
		-t attr -n "name" -v "$INTF" \
		-r "//interface_tmp" -v interface $CONFIG

done

# update dnsmasq config to prevent forwarding to resolvconf
sed -i "/$IGNORE_RESOLVCONF=yes/ s/# *//" /etc/default/dnsmasq
echo "nameserver 8.8.8.8" > /etc/resolv.dnsmasq
echo "nameserver 127.0.0.1" > /etc/resolv.conf


# add specific configuration
db_get madesimpleras/intfSelect
WAN_INTF=$RET

db_get madesimpleras/intfModeSelect
WAN_INTF_MODE=$RET

# add IPv4 config to the interface
xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']" -t elem -n ipv4 -v "" $CONFIG

# if static IP is required, add the details
if [ $WAN_INTF_MODE = "Static" ]
then
	# get the address/netmask from debconf
	db_get madesimpleras/intfStaticAddress
	WAN_INTF_ADDRESS=$RET
	db_get madesimpleras/intfStaticNetmask
	WAN_INTF_NETMASK=$RET
	db_get madesimpleras/intfStaticGateway
	WAN_INTF_GATEWAY=$RET
	
	# add the address/netmask to the config
	xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']/ipv4" -t elem -n "address" -v "$WAN_INTF_ADDRESS" $CONFIG
	xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']/ipv4" -t elem -n "netmask" -v "$WAN_INTF_NETMASK" $CONFIG
	
	# add the route to the interface
	if [ "$WAN_INTF_GATEWAY" != "" ]
	then
		xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']" -t elem -n "route_tmp" -v "" $CONFIG
		xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']/route_tmp" -t attr -n "dest" -v "0.0.0.0/0" $CONFIG
		xmlstarlet ed -L -s "/config/interfaces/interface[@name='$WAN_INTF']/route_tmp" -t attr -n "next-hop" -v "$WAN_INTF_GATEWAY" $CONFIG
		xmlstarlet ed -L -r "//route_tmp" -v "route" $CONFIG
	fi
fi

# add masquerading to the firewall config
xmlstarlet ed -L -s "/config/firewall" -t elem -n "rule_tmp" -v "" $CONFIG
xmlstarlet ed -L -s "/config/firewall/rule_tmp" -t attr -n "table" -v "nat" $CONFIG
xmlstarlet ed -L -s "/config/firewall/rule_tmp" -t attr -n "chain" -v "POSTROUTING" $CONFIG
xmlstarlet ed -L -s "/config/firewall/rule_tmp" -t elem -n "egress" -v "$WAN_INTF" $CONFIG
xmlstarlet ed -L -s "/config/firewall/rule_tmp" -t elem -n "target" -v "masquerade" $CONFIG
xmlstarlet ed -L -r "//rule_tmp" -v "rule" $CONFIG

# restart services
service rasconfig restart || true
service networking restart || true
service dnsmasq restart || true
service freeradius restart || true

# end the script
db_stop